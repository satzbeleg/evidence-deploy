version: '3'

services:
  evidence-database:
    image: citusdata/citus:9.4-alpine
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_HOST_AUTH_METHOD: trust
    ports:
      - "${DATABASE_HOST_PORT}:5432"   # 55015
    volumes: 
      - ./psql-setup/:/docker-entrypoint-initdb.d/
    networks:
      evidence-backend-network:
        ipv4_address: 172.20.253.5
  
  evidence-pgadmin4:
    image: dpage/pgadmin4
    environment:
      PGADMIN_DEFAULT_EMAIL: test@mail.com
      PGADMIN_DEFAULT_PASSWORD: password1234
    ports:
      - "${PGADMIN_HOST_PORT}:80"   # 55016
    networks:
      evidence-backend-network:
        ipv4_address: 172.20.253.6

  evidence-restapi:
    build:   # build using Dockfile in this directory
      context: .
      dockerfile: Dockerfile
    command: sh -c "gunicorn app.main:app 
                      --bind 0.0.0.0:80 
                      --worker-class uvicorn.workers.UvicornH11Worker 
                      --workers ${RESTAPI_NUM_WORKERS}
                      --worker-tmp-dir /dev/shm"
    ports:
      - "${RESTAPI_HOST_PORT}:80"
    environment:
      - EV_PSQL_HOST=172.20.253.5
      - EV_PSQL_PORT=5432
      - EV_PSQL_USERNAME=${POSTGRES_USER}
      - EV_PSQL_PASSWORD=${POSTGRES_PASSWORD}
    networks:
      evidence-backend-network:
        ipv4_address: 172.20.253.7

  evidence-app:
    build: 
      context: .
      dockerfile: Dockerfile
    ports:
      - "${WEBAPP_HOST_PORT}:8080"  # 55018
    networks:
      evidence-frontend-network:
        ipv4_address: 172.20.253.17

networks:
  evidence-frontend-network:
    external: true
    evidence-backend-network:
      external: true
  